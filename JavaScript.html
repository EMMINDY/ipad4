<script>
// ==========================================
// ระบบตรวจสอบสถานะ iPad - Client-side Script
// โรงเรียนอรัญประเทศ
// ==========================================

// ─── State Variables ───────────────────────────────────────
var systemData = [];
var currentLevel = '';
var adminMode = 'all';
var currentUser = null;
var dataTableInstance = null;
var auditOrphansData = [];
var uploadDocPersonList = [];

// ─── Preview State ─────────────────────────────────────────
var _previewScale = 1;
var _previewRotation = 0;

// ==========================================
// UTILITY FUNCTIONS
// ==========================================

/** แสดง spinner บนปุ่ม แล้วคืนสภาพหลัง fn เสร็จ */
function btnClick(btn, fn) {
  if (btn && btn.disabled) return;
  var origHtml = btn ? btn.innerHTML : '';
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>';
  }
  try {
    var result = typeof fn === 'function' ? fn() : undefined;
    if (result && typeof result.then === 'function') {
      result.finally(function () {
        if (btn) { btn.disabled = false; btn.innerHTML = origHtml; }
      });
    } else {
      setTimeout(function () {
        if (btn) { btn.disabled = false; btn.innerHTML = origHtml; }
      }, 500);
    }
  } catch (e) {
    if (btn) { btn.disabled = false; btn.innerHTML = origHtml; }
    showError(e);
  }
}

/** แสดง Global Loading Overlay */
function showGlobalLoading(message) {
  var overlay = document.getElementById('global-loading-overlay');
  if (!overlay) return;
  overlay.style.display = 'flex';
  overlay.classList.remove('hidden');
  var txt = document.getElementById('global-loading-text');
  if (txt) txt.textContent = message || 'กำลังประมวลผล...';
}

/** ซ่อน Global Loading Overlay */
function hideGlobalLoading() {
  var overlay = document.getElementById('global-loading-overlay');
  if (!overlay) return;
  overlay.classList.add('hidden');
  overlay.style.display = 'none';
}

/** ทำให้ค่าห้องเรียนเป็นรูปแบบมาตรฐาน (เช่น "ม.3/1" -> "1") */
function normalizeRoomValue(val) {
  if (val == null) return '';
  var s = String(val).trim();
  if (!s) return '';
  var parts = s.split('/');
  return parts[parts.length - 1];
}

/** คืน CSS class ของ badge ตามสถานะการยืม */
function getBorrowBadgeClass(status) {
  var map = {
    'ยืมอยู่': 'success',
    'อยู่ระหว่างการส่งคืน': 'warning',
    'คืนแล้ว': 'primary',
    'ส่งซ่อม': 'danger',
    'สละสิทธิ์': 'danger'
  };
  return map[status] || 'secondary';
}

/** คืน CSS class ของ badge ตามสถานะเอกสาร */
function getDocBadgeClass(status) {
  var map = {
    'เอกสารผ่าน': 'success',
    'เอกสารไม่ผ่าน': 'danger',
    'รอตรวจสอบ': 'warning'
  };
  return map[status] || 'secondary';
}

/** Escape HTML เพื่อป้องกัน XSS */
function escapeHtml(s) {
  return String(s || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

/** แสดง error dialog */
function showError(err) {
  var msg = (err && err.message) ? err.message : (typeof err === 'string' ? err : 'เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ');
  Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: msg, confirmButtonText: 'ตกลง' });
}

/** อ่านไฟล์เป็น Base64 Data URL */
function readFileAsBase64(file, callback) {
  if (!file) { callback(null); return; }
  var reader = new FileReader();
  reader.onload = function (e) { callback(typeof e.target.result === 'string' ? e.target.result : null); };
  reader.onerror = function () { callback(null); };
  reader.readAsDataURL(file);
}

/** สร้าง timestamp สำหรับชื่อไฟล์ */
function getTimestamp() {
  var d = new Date();
  var pad = function (n) { return String(n).padStart(2, '0'); };
  return d.getFullYear() + pad(d.getMonth() + 1) + pad(d.getDate()) + '_' + pad(d.getHours()) + pad(d.getMinutes());
}


// ==========================================
// TOAST NOTIFICATIONS
// ==========================================

/** แสดง Toast notification เบาๆ (ไม่บล็อค UI) */
function showToast(message, type, duration) {
  type = type || 'success';
  duration = duration || 2500;
  var colors = { success: '#198754', error: '#dc3545', warning: '#ffc107', info: '#0dcaf0' };
  Swal.fire({
    toast: true,
    position: 'top-end',
    icon: type,
    title: message,
    showConfirmButton: false,
    timer: duration,
    timerProgressBar: true,
    background: '#fff',
    iconColor: colors[type] || colors.success
  });
}

/** แสดง confirm dialog พร้อม icon */
function confirmAction(title, text, confirmText) {
  return Swal.fire({
    title: title || 'ยืนยัน?',
    text: text || '',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: confirmText || 'ยืนยัน',
    cancelButtonText: 'ยกเลิก',
    confirmButtonColor: '#0d6efd',
    reverseButtons: true
  });
}

// ==========================================
// INITIALIZATION
// ==========================================

$(document).ready(function () {
  var loader = document.getElementById('initial-page-loader');
  if (loader) loader.style.display = 'none';
});

// ==========================================
// VIEW MANAGEMENT
// ==========================================

function showView(id) {
  ['view-landing', 'view-dashboard', 'view-table', 'view-admin'].forEach(function (v) {
    var el = document.getElementById(v);
    if (el) el.classList.add('hidden');
  });
  var target = document.getElementById(id);
  if (target) target.classList.remove('hidden');
  var nav = document.getElementById('main-nav');
  if (nav) nav.classList.toggle('hidden', id === 'view-landing');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function goLanding() {
  currentUser = null;
  showView('view-landing');
}

function goHome() {
  if (currentUser && (currentUser.role === 'advisor' || currentUser.role === 'admin')) {
    showView('view-admin');
    loadAdminView();
  } else {
    showView('view-dashboard');
    loadDashboard();
  }
}

function enterSystem() {
  showView('view-dashboard');
  loadDashboard();
}

// ==========================================
// DASHBOARD
// ==========================================

function loadDashboard() {
  showGlobalLoading('กำลังโหลดข้อมูล...');
  var done = 0;
  function checkDone() { done++; if (done >= 2) hideGlobalLoading(); }

  google.script.run
    .withSuccessHandler(function (stats) {
      if (stats) {
        ['totalAssetsText', 'borrowedCountText', 'availableCountText'].forEach(function (id, i) {
          var keys = ['total', 'borrowed', 'available'];
          var el = document.getElementById(id);
          if (el) el.textContent = stats[keys[i]] || 0;
        });
      }
      checkDone();
    })
    .withFailureHandler(function (err) { checkDone(); showError(err); })
    .getDashboardStats();

  google.script.run
    .withSuccessHandler(function (data) {
      systemData = data || [];
      renderDashboardGrid();
      if (!systemData.length) {
        Swal.fire({ icon: 'info', title: 'ไม่พบรายชื่อ', text: 'กรุณาตรวจสอบชื่อชีตใน Google Sheets' });
      }
      checkDone();
    })
    .withFailureHandler(function (err) { checkDone(); showError(err); })
    .getAllSystemData();
}

function renderDashboardGrid() {
  var levels = {};
  systemData.forEach(function (p) {
    var src = p.source_sheet || '-';
    if (!levels[src]) levels[src] = { count: 0 };
    levels[src].count++;
  });

  var html = '';
  ['รายชื่อนักเรียน ม.3', 'รายชื่อนักเรียน ม.4', 'รายชื่อนักเรียน ม.5', 'รายชื่อนักเรียน ม.6'].forEach(function (lv) {
    var c = (levels[lv] && levels[lv].count) || 0;
    html += '<div class="col-6 col-md-3"><div class="card level-card shadow-sm" onclick="openLevel(\'' + escapeHtml(lv) + '\')">' +
      '<div class="level-icon"><i class="fas fa-graduation-cap"></i></div>' +
      '<h5 class="fw-bold text-primary">' + escapeHtml(lv.replace('รายชื่อนักเรียน ', '')) + '</h5>' +
      '<small class="text-muted">' + c + ' คน</small></div></div>';
  });
  var tc = (levels['รายชื่อครู'] && levels['รายชื่อครู'].count) || 0;
  html += '<div class="col-6 col-md-3"><div class="card level-card shadow-sm" onclick="openLevel(\'รายชื่อครู\')">' +
    '<div class="level-icon"><i class="fas fa-chalkboard-teacher"></i></div>' +
    '<h5 class="fw-bold text-info">ครู</h5><small class="text-muted">' + tc + ' คน</small></div></div>';
  document.getElementById('dashboard-grid').innerHTML = html;
}

// ==========================================
// TABLE VIEW
// ==========================================

function openLevel(level) {
  currentLevel = level;
  var t = document.getElementById('table-title');
  var b = document.getElementById('table-badge');
  if (t) t.textContent = 'รายชื่อ - ' + level;
  if (b) b.textContent = level;
  showView('view-table');
  applyTableFilters();
}

function goBackToDashboard() {
  showView('view-dashboard');
  loadDashboard();
}

function getFilteredTableRows() {
  var base = systemData.filter(function (p) { return (p.source_sheet || '') === currentLevel; });
  var roomV = (document.getElementById('roomFilter') || {}).value || '';
  var statusV = (document.getElementById('statusFilter') || {}).value || '';
  var docV = (document.getElementById('docFilter') || {}).value || '';

  var rows = base.filter(function (p) {
    if (roomV && (p.room || '') !== roomV) return false;
    if (statusV && (p.borrowStatus || '') !== statusV) return false;
    if (docV && (p.docStatus || 'ยังไม่ส่ง') !== docV) return false;
    return true;
  });

  var sortV = (document.getElementById('sortByFilter') || {}).value || 'name';
  rows.sort(function (a, b) {
    if (sortV === 'id') return String(a.id || '').localeCompare(String(b.id || ''));
    if (sortV === 'room') return String(a.room || '').localeCompare(String(b.room || ''));
    if (sortV === 'status') return String(a.borrowStatus || '').localeCompare(String(b.borrowStatus || ''));
    return String(a.name || '').localeCompare(String(b.name || ''), 'th');
  });
  return rows;
}

function applyTableFilters() {
  var rooms = [], seen = {};
  systemData.filter(function (p) { return (p.source_sheet || '') === currentLevel; }).forEach(function (r) {
    var rn = r.room || '-';
    if (!seen[rn]) { seen[rn] = 1; rooms.push(rn); }
  });
  var sel = document.getElementById('roomFilter');
  if (sel) {
    var curVal = sel.value;
    sel.innerHTML = '<option value="">ทุกห้อง</option>' + rooms.sort().map(function (r) {
      return '<option value="' + escapeHtml(r) + '">ห้อง ' + escapeHtml(r) + '</option>';
    }).join('');
    if (curVal) sel.value = curVal;
  }
  var rows = getFilteredTableRows();
  var countEl = document.getElementById('filteredCountText');
  if (countEl) countEl.textContent = rows.length;
  renderTable(rows);
}

function renderTable(rows) {
  var thead = document.querySelector('#dataTable thead');
  if (thead) thead.innerHTML = '<tr><th>รหัส</th><th>ชื่อ-นามสกุล</th><th>ห้อง</th><th>Serial</th><th>สถานะเครื่อง</th><th>สถานะเอกสาร</th></tr>';
  var tbody = document.querySelector('#dataTable tbody');
  if (tbody) tbody.innerHTML = rows.map(function (r) {
    var bs = r.borrowStatus || 'ยังไม่ยืม';
    var ds = r.docStatus || 'ยังไม่ส่ง';
    return '<tr><td>' + escapeHtml(r.id) + '</td><td class="fw-bold">' + escapeHtml(r.name) + '</td>' +
      '<td>' + escapeHtml(r.room || '-') + '</td>' +
      '<td><code class="small text-muted">' + escapeHtml(r.serial || '-') + '</code></td>' +
      '<td><span class="badge bg-' + getBorrowBadgeClass(bs) + '">' + escapeHtml(bs) + '</span></td>' +
      '<td><span class="badge bg-' + getDocBadgeClass(ds) + '">' + escapeHtml(ds) + '</span></td></tr>';
  }).join('');
  var countEl = document.getElementById('filteredCountText');
  if (countEl) countEl.textContent = rows.length;
  if (dataTableInstance) { try { dataTableInstance.destroy(); } catch (e) { } dataTableInstance = null; }
  dataTableInstance = $('#dataTable').DataTable({ pageLength: 25, order: [], language: { url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/th.json' } });
}

// ==========================================
// UPLOAD DOCUMENT MODAL
// ==========================================

function showUploadDocModal(type) {
  var form = document.getElementById('uploadDocForm');
  if (form) form.reset();
  var search = document.getElementById('ud_searchName');
  if (search) search.value = '';
  if (type) {
    var rb = document.getElementById('ud_type_borrow');
    var rr = document.getElementById('ud_type_return');
    if (rb) rb.checked = type === 'borrow';
    if (rr) rr.checked = type === 'return';
  }
  document.getElementById('ud_personSelect').innerHTML = '<option value="">-- กำลังโหลดรายชื่อ... --</option>';
  $('#uploadDocModal').modal('show');
  google.script.run
    .withSuccessHandler(function (data) { uploadDocPersonList = data || []; filterUploadPersonList(); })
    .withFailureHandler(function (err) {
      document.getElementById('ud_personSelect').innerHTML = '<option value="">-- โหลดไม่สำเร็จ --</option>';
      showError(err);
    })
    .getAllSystemData();
}

function filterUploadPersonList() {
  var q = ((document.getElementById('ud_searchName') || {}).value || '').toLowerCase().trim();
  var sel = document.getElementById('ud_personSelect');
  if (!sel) return;
  var filtered = (uploadDocPersonList || []).filter(function (p) {
    return !q || (p.name || '').toLowerCase().indexOf(q) >= 0 || String(p.id || '').toLowerCase().indexOf(q) >= 0;
  });
  sel.innerHTML = '<option value="">-- เลือกชื่อ (' + filtered.length + ' รายการ) --</option>' +
    filtered.map(function (p) {
      return '<option value="' + escapeHtml(p.id) + '|' + escapeHtml(p.source_sheet || '') + '">' +
        escapeHtml(p.name) + (p.type === 'teacher' ? ' (ครู)' : ' (ห้อง ' + escapeHtml(p.room || '') + ')') +
        '</option>';
    }).join('');
}

function handleUploadDocSubmit(form) {
  var typeEl = document.querySelector('input[name="ud_type"]:checked');
  var uploadType = typeEl ? typeEl.value : 'borrow';
  var selVal = document.getElementById('ud_personSelect').value;
  if (!selVal) { Swal.fire({ icon: 'warning', title: 'กรุณาเลือกชื่อ' }); return false; }
  var parts = selVal.split('|');
  var p = uploadDocPersonList.find(function (x) { return String(x.id) === String(parts[0]) && (x.source_sheet || '') === (parts[1] || ''); });
  if (!p) { Swal.fire({ icon: 'error', title: 'ไม่พบข้อมูล กรุณาเลือกใหม่' }); return false; }
  var fileInput = form.querySelector('[name="ud_file"]');
  if (!fileInput || !fileInput.files[0]) { Swal.fire({ icon: 'warning', title: 'กรุณาเลือกไฟล์ PDF' }); return false; }
  var obj = { userId: p.id, userName: p.name, userType: p.type, userRoom: p.room, userSerial: p.serial,
              source_sheet: p.source_sheet || '', uploadType: uploadType,
              note: (form.querySelector('[name="ud_note"]') || {}).value || '' };
  readFileAsBase64(fileInput.files[0], function (b64) {
    if (!b64) { Swal.fire({ icon: 'error', title: 'ไม่สามารถอ่านไฟล์ได้' }); return; }
    obj.file_b64 = b64;
    showGlobalLoading('กำลังอัปโหลดเอกสาร...');
    google.script.run
      .withSuccessHandler(function (res) {
        hideGlobalLoading();
        if (res.success) { showToast('อัปโหลดเรียบร้อย'); $('#uploadDocModal').modal('hide'); }
        else Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: res.message });
      })
      .withFailureHandler(function (err) { hideGlobalLoading(); showError(err); })
      .processUploadDoc(obj);
  });
  return false;
}

// ==========================================
// LOGIN
// ==========================================

function showAdvisorLogin() { $('#advisorLoginModal').modal('show'); }
function showAdminLogin() { $('#adminLoginModal').modal('show'); }

function loginAdmin() {
  var u = document.getElementById('adminUsernameInput').value.trim();
  var p = document.getElementById('adminPasswordInput').value;
  if (!u || !p) { Swal.fire({ icon: 'warning', title: 'กรุณากรอก Username และ Password' }); return; }
  showGlobalLoading('กำลังตรวจสอบ...');
  google.script.run
    .withSuccessHandler(function (res) {
      hideGlobalLoading();
      if (res.success) {
        currentUser = { role: 'admin' };
        document.getElementById('adminPasswordInput').value = '';
        $('#adminLoginModal').modal('hide');
        showView('view-admin');
        loadAdminView();
      } else Swal.fire({ icon: 'error', title: 'เข้าสู่ระบบไม่สำเร็จ', text: res.message || 'Username หรือ Password ไม่ถูกต้อง' });
    })
    .withFailureHandler(function (err) { hideGlobalLoading(); showError(err); })
    .verifyAdmin(u, p);
}

function loginAdvisor() {
  var u = document.getElementById('advUsernameInput').value.trim();
  var p = document.getElementById('advPasswordInput').value;
  if (!u || !p) { Swal.fire({ icon: 'warning', title: 'กรุณากรอก Username และ Password' }); return; }
  showGlobalLoading('กำลังตรวจสอบ...');
  google.script.run
    .withSuccessHandler(function (res) {
      hideGlobalLoading();
      if (res.success) {
        currentUser = { role: 'advisor', name: res.name, level: res.level, room: res.room };
        document.getElementById('advPasswordInput').value = '';
        $('#advisorLoginModal').modal('hide');
        showView('view-admin');
        loadAdminView();
      } else Swal.fire({ icon: 'error', title: 'เข้าสู่ระบบไม่สำเร็จ', text: res.message || 'Username หรือ Password ไม่ถูกต้อง' });
    })
    .withFailureHandler(function (err) { hideGlobalLoading(); showError(err); })
    .verifyAdvisor(u, p);
}

function exitAdmin() { currentUser = null; goLanding(); }

// ==========================================
// ADMIN VIEW
// ==========================================

function loadAdminView() {
  showGlobalLoading('กำลังโหลดรายชื่อทั้งหมด...');
  google.script.run
    .withSuccessHandler(function (data) {
      systemData = data || [];
      updateAdminUIForRole();
      if (currentUser && currentUser.role === 'advisor') {
        filterAdminTable();
      } else {
        // Admin: ดึง summary จาก server เพื่อความแม่นยำ
        updateAdminStats(); // อัปเดต local ก่อน
        filterAdminTable();
        // ดึง server stats แยก (non-blocking)
        google.script.run
          .withSuccessHandler(function(summary) {
            if (summary && summary.success) {
              var setEl = function(id, v) { var e = document.getElementById(id); if(e) e.textContent = v; };
              setEl('stat-total', summary.total || 0);
              setEl('stat-borrowed', summary.borrowed || 0);
              setEl('stat-notborrow', summary.notBorrow || 0);
              setEl('stat-pending', summary.pending || 0);
              setEl('stat-returned', summary.returned || 0);
              setEl('stat-repair', summary.repair || 0);
            }
          })
          .withFailureHandler(function() { /* ใช้ค่า local แทน */ })
          .getAdminSummary();
      }
      hideGlobalLoading();
    })
    .withFailureHandler(function (err) { hideGlobalLoading(); showError(err); })
    .getAllSystemData();
}

function updateAdminUIForRole() {
  var titleEl = document.getElementById('admin-title-text');
  var roleEl = document.getElementById('adminRoleDisplay');
  var filterBox = document.getElementById('adminFilterBox');
  var btnAddUser = document.getElementById('btn-add-user');
  var btnAudit = document.getElementById('btn-audit-missing');
  if (currentUser && currentUser.role === 'advisor') {
    if (titleEl) titleEl.textContent = 'ครูที่ปรึกษา';
    if (roleEl) {
      var lv = String(currentUser.level || '').trim();
      if (lv && lv.indexOf('ม.') < 0) lv = 'ม.' + lv;
      roleEl.innerHTML = 'กำลังใช้งาน: <span class="fw-bold text-primary">' + escapeHtml(currentUser.name || 'คุณครู') + '</span>' +
        ' — ห้อง <span class="fw-bold">' + escapeHtml(currentUser.room || '-') + '</span>' +
        (lv ? ' <span class="badge bg-light text-dark border">' + escapeHtml(lv) + '</span>' : '');
    }
    if (filterBox) filterBox.classList.add('d-none');
    if (btnAddUser) btnAddUser.style.display = 'none';
    if (btnAudit) btnAudit.style.display = 'none';
  } else {
    if (titleEl) titleEl.textContent = 'ผู้ดูแลระบบ';
    if (roleEl) roleEl.innerHTML = 'กำลังใช้งานสิทธิ์: <span class="fw-bold text-danger">แอดมิน</span>';
    if (filterBox) filterBox.classList.remove('d-none');
    if (btnAddUser) btnAddUser.style.display = '';
    if (btnAudit) btnAudit.style.display = '';
  }
}

function updateAdminStats(dataToCount) {
  var arr = Array.isArray(dataToCount) ? dataToCount : systemData;
  var t = 0, b = 0, nb = 0, pd = 0, ret = 0, rep = 0;
  arr.forEach(function (p) {
    t++;
    var s = p.borrowStatus || '';
    if (s === 'ยืมอยู่' || s === 'อยู่ระหว่างการส่งคืน') b++;
    else if (s === 'ยังไม่ยืม') nb++;
    else if (s === 'คืนแล้ว') ret++;
    else if (s === 'ส่งซ่อม' || s === 'สละสิทธิ์') rep++;
    if ((p.docStatus || '') === 'รอตรวจสอบ') pd++;
  });
  $('#stat-total').text(t); $('#stat-borrowed').text(b); $('#stat-notborrow').text(nb);
  $('#stat-pending').text(pd); $('#stat-returned').text(ret); $('#stat-repair').text(rep);
}

function setAdminMode(mode) {
  adminMode = mode;
  $('#btnModeAll, #btnModeReturn, #btnModeDoc').removeClass('btn-primary').addClass('btn-light');
  var ids = { all: '#btnModeAll', 'return': '#btnModeReturn', doc: '#btnModeDoc' };
  if (ids[mode]) $(ids[mode]).removeClass('btn-light').addClass('btn-primary');
  filterAdminTable();
}

function filterAdminTable() {
  var lf = document.getElementById('adminLevelFilter');
  var rf = document.getElementById('adminRoomFilter');
  var lv = '', rm = '';
  if (currentUser && currentUser.role === 'advisor') {
    var levelKey = String(currentUser.level || '').trim();
    if (levelKey && levelKey.indexOf('ม.') < 0) levelKey = 'ม.' + levelKey;
    var allSheets = [];
    systemData.forEach(function (r) { var s = r.source_sheet || ''; if (s && allSheets.indexOf(s) < 0) allSheets.push(s); });
    lv = allSheets.find(function (l) { return l.indexOf('นักเรียน') >= 0 && (levelKey ? l.indexOf(levelKey) >= 0 : true); }) || '';
    rm = String(currentUser.room || '').trim();
  } else {
    lv = lf ? lf.value : '';
    rm = rf ? rf.value : '';
  }
  var tRoomNorm = normalizeRoomValue(rm);
  var statusFilter = (document.getElementById('adminStatusFilter') || {}).value || '';
  var sortFilter = (document.getElementById('adminSortFilter') || {}).value || 'name';
  var rows = systemData.filter(function (p) {
    if (lv && (p.source_sheet || '').indexOf(lv) < 0) return false;
    if (tRoomNorm && normalizeRoomValue(p.room) !== tRoomNorm) return false;
    if (statusFilter && (p.borrowStatus || '') !== statusFilter) return false;
    if (adminMode === 'return') return (p.borrowStatus || '').indexOf('อยู่ระหว่างการส่งคืน') >= 0;
    if (adminMode === 'doc') return (p.docStatus || '') === 'รอตรวจสอบ';
    return true;
  });
  rows.sort(function (a, b) {
    if (sortFilter === 'id') return String(a.id || '').localeCompare(String(b.id || ''));
    if (sortFilter === 'room') return String(a.room || '').localeCompare(String(b.room || ''));
    if (sortFilter === 'status') return String(a.borrowStatus || '').localeCompare(String(b.borrowStatus || ''));
    return String(a.name || '').localeCompare(String(b.name || ''), 'th');
  });
  if (currentUser && currentUser.role === 'advisor') updateAdminStats(rows);
  renderAdminTable(rows, lv, rm);
}

function renderAdminTable(rows, preserveLevel, preserveRoom) {
  var levels = [], rooms = {};
  systemData.forEach(function (r) {
    var s = r.source_sheet || '';
    if (s && levels.indexOf(s) < 0) levels.push(s);
    if (s) { if (!rooms[s]) rooms[s] = []; if (rooms[s].indexOf(r.room || '-') < 0) rooms[s].push(r.room || '-'); }
  });
  var lf = document.getElementById('adminLevelFilter');
  var rf = document.getElementById('adminRoomFilter');
  if (lf) {
    lf.innerHTML = '<option value="">ทุกระดับชั้น</option>' + levels.sort().map(function (l) { return '<option value="' + escapeHtml(l) + '">' + escapeHtml(l) + '</option>'; }).join('');
    if (preserveLevel && levels.indexOf(preserveLevel) >= 0) lf.value = preserveLevel;
  }
  if (rf) {
    var rlist = (lf && lf.value && rooms[lf.value]) ? rooms[lf.value] : [];
    rf.innerHTML = '<option value="">ทุกห้อง</option>' + rlist.sort().map(function (r) { return '<option value="' + escapeHtml(r) + '">' + escapeHtml(r) + '</option>'; }).join('');
    if (preserveRoom && rlist.indexOf(preserveRoom) >= 0) rf.value = preserveRoom;
  }
  var isAdvisor = currentUser && currentUser.role === 'advisor';
  var isAdmin = currentUser && currentUser.role === 'admin';
  var tbody = document.querySelector('#adminTable tbody');
  tbody.innerHTML = rows.map(function (r) {
    var bs = r.borrowStatus || 'ยังไม่ยืม';
    var ds = r.docStatus || 'ยังไม่ส่ง';
    var retText = '-', retClass = 'secondary';
    if (bs.indexOf('อยู่ระหว่างการส่งคืน') >= 0) { retText = 'รออนุมัติคืน'; retClass = 'warning'; }
    else if (bs === 'คืนแล้ว') { retText = 'คืนแล้ว'; retClass = 'success'; }
    var safeId = escapeHtml(r.id);
    var safeSheet = escapeHtml(r.source_sheet || '');
    var action = '<button class="btn btn-sm btn-outline-primary me-1 mb-1" onclick="openActionModal(\'' + safeId + '\',\'' + safeSheet + '\')" title="ดู/อัปโหลดเอกสาร"><i class="fas fa-file-alt"></i></button>';
    if (isAdmin) {
      action += '<button class="btn btn-sm btn-outline-danger me-1 mb-1" onclick="openAdminEdit(\'' + safeId + '\',\'' + safeSheet + '\')" title="แก้ไขข้อมูล"><i class="fas fa-cog"></i></button>';
      if (bs.indexOf('อยู่ระหว่างการส่งคืน') >= 0) {
        action += '<button class="btn btn-sm btn-warning mb-1" onclick="openAdvisorReturnModal(\'' + safeId + '\')" title="ยืนยันการคืน"><i class="fas fa-undo"></i></button>';
      }
    }
    if (isAdvisor && ds === 'รอตรวจสอบ') {
      action += '<button class="btn btn-sm btn-success mb-1" onclick="advisorApproveDoc(\'' + safeId + '\',\'' + safeSheet + '\',\'' +
        escapeHtml(r.name || '') + '\',\'' + escapeHtml(r.room || '') + '\',\'' + escapeHtml(r.serial || '') + '\',\'' + escapeHtml(r.type || 'student') + '\')" title="อนุมัติเอกสาร"><i class="fas fa-check"></i> อนุมัติ</button>';
    }
    return '<tr><td class="small text-muted">' + escapeHtml(r.id) + '</td><td class="fw-bold">' + escapeHtml(r.name) + '</td>' +
      '<td><span class="badge bg-' + getBorrowBadgeClass(bs) + '">' + escapeHtml(bs) + '</span></td>' +
      '<td><span class="badge bg-' + getDocBadgeClass(ds) + '">' + escapeHtml(ds) + '</span></td>' +
      '<td><span class="badge bg-' + retClass + '">' + retText + '</span></td>' +
      '<td style="white-space:nowrap;">' + action + '</td></tr>';
  }).join('');
  var badge = document.getElementById('adminTableBadge');
  if (badge) badge.textContent = rows.length + ' รายการ';
  var countEl = document.getElementById('adminFilteredCount');
  if (countEl) countEl.textContent = rows.length;
}

// ==========================================
// ADVISOR APPROVE DOC
// ==========================================

function advisorApproveDoc(id, sheet, userName, userRoom, userSerial, userType) {
  Swal.fire({
    title: 'ยืนยันอนุมัติเอกสาร?',
    html: '<strong>' + escapeHtml(userName) + '</strong><br><small class="text-muted">ห้อง ' + escapeHtml(userRoom) + ' | Serial: ' + escapeHtml(userSerial) + '</small>',
    icon: 'question', showCancelButton: true,
    confirmButtonText: '<i class="fas fa-check me-1"></i>อนุมัติ',
    cancelButtonText: 'ยกเลิก', confirmButtonColor: '#198754'
  }).then(function (res) {
    if (!res.isConfirmed) return;
    showGlobalLoading('กำลังอนุมัติ...');
    google.script.run
      .withSuccessHandler(function (r) {
        hideGlobalLoading();
        if (r.success) { showToast('อนุมัติเอกสารเรียบร้อย'); loadAdminView(); }
        else Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: r.message });
      })
      .withFailureHandler(function (err) { hideGlobalLoading(); showError(err); })
      .advisorApproveDoc({ userId: id, source_sheet: sheet, userName: userName || '', userRoom: userRoom || '', userSerial: userSerial || '', userType: userType || 'student', editorName: currentUser ? currentUser.name : '' });
  });
}

// ==========================================
// REFRESH
// ==========================================

function refreshSystemData() {
  showGlobalLoading('กำลังอัปเดตและซิงค์ข้อมูล...');
  google.script.run
    .withSuccessHandler(function (data) {
      systemData = data || [];
      updateAdminUIForRole();
      if (currentUser && currentUser.role === 'advisor') filterAdminTable();
      else { updateAdminStats(); filterAdminTable(); }
      hideGlobalLoading();
      showToast('ซิงค์ข้อมูลเรียบร้อย');
    })
    .withFailureHandler(function (err) { hideGlobalLoading(); showError(err); })
    .refreshAndSyncData();
}

// ==========================================
// ACTION MODAL
// ==========================================

function openActionModal(id, sheet) {
  var p = systemData.find(function (x) { return String(x.id) === String(id) && (x.source_sheet || '') === sheet; });
  if (!p) { showError('ไม่พบข้อมูลผู้ใช้'); return; }
  document.getElementById('m_userId').value = p.id;
  document.getElementById('m_userType').value = p.type || 'student';
  document.getElementById('m_userRoom').value = p.room || '';
  document.getElementById('m_userName').value = p.name || '';
  document.getElementById('m_displayName').textContent = p.name;
  document.getElementById('m_userSerial_input').value = p.serial || '-';
  var bs = p.borrowStatus || 'ยังไม่ยืม';
  var ds = p.docStatus || 'ยังไม่ส่ง';
  var bb = document.getElementById('m_borrow_badge');
  var db = document.getElementById('m_doc_badge');
  if (bb) { bb.textContent = bs; bb.className = 'badge bg-' + getBorrowBadgeClass(bs); }
  if (db) { db.textContent = ds; db.className = 'badge bg-' + getDocBadgeClass(ds); }
  var statusSel = document.querySelector('#updateForm [name="statusSelect"]');
  if (statusSel) statusSel.value = bs;
  // เก็บ source_sheet ไว้ใน hidden field เพื่อส่งให้ processForm
  var ssField = document.getElementById('m_sourceSheet');
  if (ssField) ssField.value = p.source_sheet || '';
  var links = [];
  if ((p.files || {}).agreement) links.push('<a href="' + escapeHtml(p.files.agreement) + '" target="_blank" class="btn btn-sm btn-outline-primary me-1"><i class="fas fa-file-pdf me-1"></i>สัญญาการยืม</a>');
  if (p.returnDocUrl) links.push('<a href="' + escapeHtml(p.returnDocUrl) + '" target="_blank" class="btn btn-sm btn-outline-warning"><i class="fas fa-file-pdf me-1"></i>หลักฐานการคืน</a>');
  document.getElementById('m_doc_links').innerHTML = links.length ? links.join('') : '<span class="text-muted small"><i class="fas fa-info-circle me-1"></i>ยังไม่มีเอกสาร</span>';
  var form = document.getElementById('updateForm');
  if (form) {
    form.querySelectorAll('input[type="file"]').forEach(function (fi) { fi.value = ''; });
    var noteEl = form.querySelector('[name="note"]');
    if (noteEl) noteEl.value = p.note || '';
  }
  $('#actionModal').modal('show');
}

function handleFormSubmit(form) {
  var obj = {
    userId: form.querySelector('[name="userId"]').value,
    userName: form.querySelector('[name="userName"]').value,
    userType: form.querySelector('[name="userType"]').value,
    userRoom: form.querySelector('[name="userRoom"]').value,
    userSerial: form.querySelector('[name="userSerial"]') ? form.querySelector('[name="userSerial"]').value : '',
    statusSelect: form.querySelector('[name="statusSelect"]') ? form.querySelector('[name="statusSelect"]').value : '',
    note: form.querySelector('[name="note"]') ? form.querySelector('[name="note"]').value : '',
    // source_sheet จำเป็นสำหรับ processForm เพื่ออัปเดตชีตรายชื่อหลัก
    source_sheet: document.getElementById('m_sourceSheet') ? document.getElementById('m_sourceSheet').value : ''
  };
  var fa = form.querySelector('[name="file_agreement"]') ? form.querySelector('[name="file_agreement"]').files[0] : null;
  var fr = form.querySelector('[name="file_return"]') ? form.querySelector('[name="file_return"]').files[0] : null;
  if (!fa && !fr && !obj.note) {
    Swal.fire({ icon: 'info', title: 'ไม่มีข้อมูลที่เปลี่ยนแปลง', text: 'กรุณาเลือกไฟล์หรือกรอกหมายเหตุก่อนบันทึก' });
    return false;
  }
  var filesToRead = [];
  if (fa) filesToRead.push({ key: 'file_agreement_b64', file: fa });
  if (fr) filesToRead.push({ key: 'file_return_b64', file: fr });
  var readNext = function (idx) {
    if (idx >= filesToRead.length) {
      showGlobalLoading('กำลังอัปโหลดเอกสาร...');
      google.script.run
        .withSuccessHandler(function (res) {
          hideGlobalLoading();
          if (res.success) { showToast('บันทึกเรียบร้อย'); $('#actionModal').modal('hide'); loadAdminView(); }
          else Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: res.message });
        })
        .withFailureHandler(function (err) { hideGlobalLoading(); showError(err); })
        .processForm(obj);
      return;
    }
    readFileAsBase64(filesToRead[idx].file, function (b64) { if (b64) obj[filesToRead[idx].key] = b64; readNext(idx + 1); });
  };
  readNext(0);
  return false;
}

// ==========================================
// ADMIN EDIT MODAL
// ==========================================

function openAdminEdit(id, sheet) {
  var p = systemData.find(function (x) { return String(x.id) === String(id) && (x.source_sheet || '') === sheet; });
  if (!p) { showError('ไม่พบข้อมูล'); return; }
  document.getElementById('adm_id').value = p.id;
  document.getElementById('adm_name').value = p.name;
  document.getElementById('adm_name_hidden').value = p.name;
  document.getElementById('adm_type').value = p.type || '';
  document.getElementById('adm_room').value = p.room || '';
  document.getElementById('adm_serial').value = p.serial || '-';
  document.getElementById('adm_borrow_status').value = p.borrowStatus || 'ยังไม่ยืม';
  document.getElementById('adm_doc_status').value = p.docStatus || '';
  document.getElementById('adm_note').value = p.note || '';
  var files = p.files || {};
  var mkLink = function (url, label, cls) {
    return url
      ? '<a href="' + escapeHtml(url) + '" target="_blank" class="btn btn-sm btn-outline-' + cls + ' me-1 mb-1"><i class="fas fa-file-pdf me-1"></i>' + label + '</a>'
      : '<span class="text-muted small">ไม่มีไฟล์</span>';
  };
  document.getElementById('adm_file_list').innerHTML = mkLink(files.agreement, 'สัญญาการยืม', 'primary');
  document.getElementById('adm_return_file_list').innerHTML = mkLink(p.returnDocUrl, 'หลักฐานการคืน', 'success');
  $('#adminEditModal').modal('show');
}

function saveAdminData() {
  var person = systemData.find(function (x) { return String(x.id) === String(document.getElementById('adm_id').value); });
  var data = {
    userId: document.getElementById('adm_id').value,
    userName: document.getElementById('adm_name').value,
    userType: document.getElementById('adm_type').value,
    userRoom: document.getElementById('adm_room').value,
    userSerial: document.getElementById('adm_serial').value,
    source_sheet: person ? (person.source_sheet || '') : '',
    borrowStatusSelect: document.getElementById('adm_borrow_status').value,
    docStatusSelect: document.getElementById('adm_doc_status').value,
    note: document.getElementById('adm_note').value,
    editorRole: currentUser ? currentUser.role : '',
    editorName: currentUser ? (currentUser.name || '') : ''
  };
  showGlobalLoading('กำลังบันทึกข้อมูล...');
  google.script.run
    .withSuccessHandler(function (res) {
      hideGlobalLoading();
      if (res.success) { showToast('บันทึกเรียบร้อย'); $('#adminEditModal').modal('hide'); loadAdminView(); }
      else Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: res.message });
    })
    .withFailureHandler(function (err) { hideGlobalLoading(); showError(err); })
    .adminUpdateData(data);
}

// ==========================================
// EXPORT
// ==========================================

function openExportModal() {
  var filterText = 'ระดับ: ' + ((document.getElementById('adminLevelFilter') || {}).value || 'ทั้งหมด') + ' | ห้อง: ' + ((document.getElementById('adminRoomFilter') || {}).value || 'ทั้งหมด');
  var el = document.getElementById('exportFilterText');
  if (el) el.textContent = filterText;
  $('#exportModal').modal('show');
}

function executeExport() {
  var scope = document.querySelector('input[name="exportScope"]:checked').value;
  var opts = scope === 'filtered' ? {
    scope: 'filtered',
    levelFilter: (document.getElementById('adminLevelFilter') || {}).value || '',
    roomFilter: (document.getElementById('adminRoomFilter') || {}).value || ''
  } : { scope: 'all' };
  showGlobalLoading('กำลังสร้างไฟล์...');
  google.script.run
    .withSuccessHandler(function (data) {
      hideGlobalLoading();
      var colDefs = [
        { id: 'col_id', key: 'id', label: 'รหัส' },
        { id: 'col_name', key: 'name', label: 'ชื่อ-นามสกุล' },
        { id: 'col_status', key: 'borrowStatus', label: 'สถานะเครื่อง' },
        { id: 'col_doc', key: 'docStatus', label: 'สถานะเอกสาร' },
        { id: 'col_level', key: 'source_sheet', label: 'ระดับชั้น' },
        { id: 'col_room', key: 'room', label: 'ห้อง' },
        { id: 'col_serial', key: 'serial', label: 'Serial Number' },
        { id: 'col_note', key: 'note', label: 'หมายเหตุ' }
      ].filter(function (c) { var el = document.getElementById(c.id); return el && el.checked; });
      var csv = '\uFEFF' + colDefs.map(function (c) { return '"' + c.label + '"'; }).join(',') + '\n';
      data.forEach(function (r) {
        csv += colDefs.map(function (c) { return '"' + String(r[c.key] || '').replace(/"/g, '""') + '"'; }).join(',') + '\n';
      });
      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'iPad_Export_' + getTimestamp() + '.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
      $('#exportModal').modal('hide');
      showToast('ดาวน์โหลดเรียบร้อย');
    })
    .withFailureHandler(function (err) { hideGlobalLoading(); showError(err); })
    .getExportData(opts);
}

// ==========================================
// REPORTS
// ==========================================

function openAdvancedReport() {
  showGlobalLoading('กำลังสร้างรายงาน...');
  google.script.run
    .withSuccessHandler(function (rows) {
      hideGlobalLoading();
      var tbody = document.getElementById('reportTableBodyProgress');
      if (tbody) {
        tbody.innerHTML = rows.map(function (r) {
          var borrowed = (r.borrowed || 0) + (r.returned || 0) + (r.repair || 0);
          var pct = r.total > 0 ? Math.round(borrowed / r.total * 100) : 0;
          var cls = pct >= 80 ? 'text-success fw-bold' : pct >= 50 ? 'text-warning' : 'text-danger';
          return '<tr><td class="text-start fw-bold">' + escapeHtml(r.level) + ' / ' + escapeHtml(r.room) + '</td>' +
            '<td>' + r.total + '</td><td class="' + cls + '">' + borrowed + ' <small>(' + pct + '%)</small></td>' +
            '<td class="text-success">' + (r.docPassed || 0) + '</td>' +
            '<td class="d-none d-md-table-cell">' + (r.notBorrowed || 0) + '</td>' +
            '<td class="d-none d-md-table-cell text-primary">' + (r.returned || 0) + '</td>' +
            '<td class="d-none d-md-table-cell text-danger">' + (r.repair || 0) + '</td></tr>';
        }).join('');
      }
      $('#reportModalProgress').modal('show');
    })
    .withFailureHandler(function (err) { hideGlobalLoading(); showError(err); })
    .getReportData();
}

// ==========================================
// AUDIT & MAPPING
// ==========================================

function openMissingAudit() {
  auditOrphansData = [];
  showGlobalLoading('กำลังตรวจสอบรายการตกหล่น...');
  google.script.run
    .withSuccessHandler(function (orphans) {
      hideGlobalLoading();
      auditOrphansData = orphans || [];
      var tbody = document.getElementById('auditTableBodyMissing');
      if (tbody) {
        tbody.innerHTML = !auditOrphansData.length
          ? '<tr><td colspan="4" class="text-center text-success py-4"><i class="fas fa-check-circle me-2 fs-4"></i>ข้อมูลครบถ้วน ไม่พบรายการตกหล่น</td></tr>'
          : auditOrphansData.map(function (o) {
            var s = (o.suggestions && o.suggestions[0]) || {};
            return '<tr><td>' + escapeHtml(s.sheet || '-') + '</td><td>' + escapeHtml(s.room || '-') + '</td>' +
              '<td class="fw-bold text-danger">' + escapeHtml(o.assetName || '-') + '</td>' +
              '<td><span class="badge bg-secondary">' + escapeHtml(o.assetStatus || o.serial || '-') + '</span></td></tr>';
          }).join('');
      }
      var countEl = document.getElementById('auditCountText');
      if (countEl) countEl.textContent = auditOrphansData.length + ' รายการ';
      $('#auditModalMissing').modal('show');
    })
    .withFailureHandler(function (err) { hideGlobalLoading(); showError(err); })
    .getAssetAuditData();
}

function openMappingModalFromMissing() {
  if (!auditOrphansData || !auditOrphansData.length) {
    Swal.fire({ icon: 'info', title: 'ไม่มีรายการที่ต้องจับคู่' });
    return;
  }
  var tbody = document.getElementById('auditTableBodyMapping');
  tbody.innerHTML = auditOrphansData.map(function (o, idx) {
    var opts = '<option value="">-- เลือกชื่อที่ถูกต้อง --</option>' +
      (o.suggestions || []).map(function (s, sidx) {
        return '<option value="' + sidx + '">' + escapeHtml(s.name) + ' (' + escapeHtml(s.sheet || '') + ', ห้อง ' + escapeHtml(s.room || '') + ')</option>';
      }).join('');
    return '<tr><td class="text-center"><input type="checkbox" class="form-check-input map-check" data-idx="' + idx + '" checked></td>' +
      '<td class="fw-bold text-danger">' + escapeHtml(o.assetName || '-') + '</td>' +
      '<td><select class="form-select form-select-sm map-select" data-idx="' + idx + '">' + opts + '</select></td>' +
      '<td class="small text-muted">' + escapeHtml(o.serial || '-') + '</td>' +
      '<td class="text-center"><span class="badge bg-warning text-dark">รอจับคู่</span></td></tr>';
  }).join('');
  document.getElementById('mappingCountText').textContent = auditOrphansData.length + ' รายการ';
  $('#auditModalMissing').modal('hide');
  $('#auditModalMapping').modal('show');
}

function saveMappingSelections() {
  var updates = [];
  document.querySelectorAll('.map-check:checked').forEach(function (cb) {
    var idx = parseInt(cb.getAttribute('data-idx'), 10);
    var sel = document.querySelector('.map-select[data-idx="' + idx + '"]');
    var suggIdx = sel ? parseInt(sel.value, 10) : NaN;
    var o = auditOrphansData[idx];
    if (!o || isNaN(suggIdx) || suggIdx < 0) return;
    var s = o.suggestions && o.suggestions[suggIdx];
    if (s && s.name) updates.push({ oldAssetName: o.assetName, correctName: s.name, serial: o.serial });
  });
  if (!updates.length) { Swal.fire({ icon: 'warning', title: 'ไม่มีรายการที่เลือก', text: 'กรุณาเลือกชื่อที่ถูกต้องใน dropdown ก่อน' }); return; }
  Swal.fire({ title: 'ยืนยันการจับคู่?', text: 'จะบันทึก ' + updates.length + ' รายการ', icon: 'question', showCancelButton: true, confirmButtonText: 'ยืนยัน', cancelButtonText: 'ยกเลิก' })
    .then(function (res) {
      if (!res.isConfirmed) return;
      showGlobalLoading('กำลังบันทึกการจับคู่...');
      google.script.run
        .withSuccessHandler(function (res) {
          hideGlobalLoading();
          if (res.success) { showToast('จับคู่ ' + res.count + ' รายการสำเร็จ'); $('#auditModalMapping').modal('hide'); openMissingAudit(); }
          else Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: res.message });
        })
        .withFailureHandler(function (err) { hideGlobalLoading(); showError(err); })
        .adminFixAssetNameBulk(updates);
    });
}

// ==========================================
// ADD USER
// ==========================================

function openAddUserModal() { $('#adminAddUserModal').modal('show'); }

function toggleNewUserFields() {
  var v = document.getElementById('new_targetSheet').value;
  var sf = document.getElementById('new_studentFields');
  if (sf) sf.style.display = (v && v.indexOf('นักเรียน') >= 0) ? 'block' : 'none';
}

function saveNewUser() {
  var sheet = document.getElementById('new_targetSheet').value;
  var name = document.getElementById('new_name').value.trim();
  var id = document.getElementById('new_id').value.trim();
  var room = document.getElementById('new_room').value;
  if (!name) { Swal.fire({ icon: 'warning', title: 'กรุณากรอกชื่อ-นามสกุล' }); return; }
  if (sheet.indexOf('นักเรียน') >= 0 && (!id || !room)) { Swal.fire({ icon: 'warning', title: 'กรุณากรอกรหัสและห้อง' }); return; }
  showGlobalLoading('กำลังเพิ่มรายชื่อ...');
  google.script.run
    .withSuccessHandler(function (res) {
      hideGlobalLoading();
      if (res.success) { showToast('เพิ่มรายชื่อเรียบร้อย'); $('#adminAddUserModal').modal('hide'); loadAdminView(); }
      else Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: res.message });
    })
    .withFailureHandler(function (err) { hideGlobalLoading(); showError(err); })
    .adminAddUser({ targetSheet: sheet, name: name, id: id || ('T-' + Date.now()), room: room || '' });
}

// ==========================================
// ADVISOR RETURN MODAL
// ==========================================

function openAdvisorReturnModal(id) {
  var p = systemData.find(function (x) { return String(x.id) === String(id); });
  if (!p) { showError('ไม่พบข้อมูล'); return; }
  document.getElementById('ar_userId').value = p.id;
  document.getElementById('ar_userType').value = p.type || '';
  document.getElementById('ar_userRoom').value = p.room || '';
  document.getElementById('ar_userName').value = p.name || '';
  document.getElementById('ar_userSerial').value = p.serial || '';
  document.getElementById('ar_showName').textContent = p.name;
  document.getElementById('ar_showSerial').textContent = p.serial || '-';
  var form = document.getElementById('advisorReturnForm');
  if (form) {
    var fi = form.querySelector('[name="file_return"]');
    if (fi) fi.value = '';
    var note = form.querySelector('[name="note"]');
    if (note) note.value = '';
  }
  $('#advisorReturnModal').modal('show');
}

function handleAdvisorReturnSubmit(form) {
  var fd = new FormData(form);
  var p_return = systemData.find(function(x){ return String(x.id) === String(fd.get('userId')); });
  var obj = { userId: fd.get('userId'), userName: fd.get('userName'), userType: fd.get('userType'),
              userRoom: fd.get('userRoom'), userSerial: fd.get('userSerial'), note: fd.get('note'),
              source_sheet: p_return ? (p_return.source_sheet || '') : '' };
  var fr = form.querySelector('[name="file_return"]').files[0];
  if (!fr) { Swal.fire({ icon: 'warning', title: 'กรุณาเลือกไฟล์หลักฐานการคืน' }); return false; }
  readFileAsBase64(fr, function (b64) {
    if (!b64) { Swal.fire({ icon: 'error', title: 'ไม่สามารถอ่านไฟล์ได้' }); return; }
    obj.file_return_b64 = b64;
    showGlobalLoading('กำลังส่งคำขอคืนเครื่อง...');
    google.script.run
      .withSuccessHandler(function (res) {
        hideGlobalLoading();
        if (res.success) { showToast('ส่งเรื่องเรียบร้อย — แอดมินจะดำเนินการต่อไป'); $('#advisorReturnModal').modal('hide'); loadAdminView(); }
        else Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: res.message });
      })
      .withFailureHandler(function (err) { hideGlobalLoading(); showError(err); })
      .processAdvisorReturn(obj);
  });
  return false;
}

// ==========================================
// PREVIEW MODAL (PDF / Image) — ฟังก์ชันสมบูรณ์
// ==========================================

/**
 * เปิด preview modal
 * @param {string} url   URL ของไฟล์
 * @param {string} type  'pdf' | 'image' (optional — ตรวจจาก URL อัตโนมัติ)
 */
function openPreviewModal(url, type) {
  if (!url) { Swal.fire({ icon: 'warning', title: 'ไม่พบลิงก์ไฟล์' }); return; }
  _previewScale = 1;
  _previewRotation = 0;

  var imgEl = document.getElementById('previewImage');
  var iframeContainer = document.getElementById('previewIframeContainer');
  var iframeEl = document.getElementById('previewIframe');
  var imgContainer = document.getElementById('imageContainer');

  var isPdf = type === 'pdf' ||
    /\.pdf($|\?)/i.test(url) ||
    url.indexOf('export=download') >= 0 ||
    url.indexOf('export=pdf') >= 0;

  if (isPdf) {
    if (imgEl) imgEl.style.display = 'none';
    if (imgContainer) imgContainer.style.transform = '';
    if (iframeContainer) iframeContainer.style.display = 'block';
    if (iframeEl) iframeEl.src = url;
  } else {
    if (iframeContainer) iframeContainer.style.display = 'none';
    if (iframeEl) iframeEl.src = '';
    if (imgEl) { imgEl.style.display = 'block'; imgEl.src = url; }
    if (imgContainer) { imgContainer.style.transform = 'scale(1) rotate(0deg)'; imgContainer.style.transformOrigin = 'top center'; }
  }
  $('#previewModal').modal('show');
}

/** ซูมรูปภาพ (factor เช่น 1.2 = zoom in, 0.8 = zoom out) */
function zoomPreview(factor) {
  _previewScale = Math.max(0.2, Math.min(5, _previewScale * factor));
  _applyPreviewTransform();
}

/** หมุนรูปภาพทีละ 90 องศา */
function rotatePreview() {
  _previewRotation = (_previewRotation + 90) % 360;
  _applyPreviewTransform();
}

/** รีเซ็ต zoom/rotate กลับค่าเดิม */
function resetPreview() {
  _previewScale = 1;
  _previewRotation = 0;
  _applyPreviewTransform();
}

function _applyPreviewTransform() {
  var container = document.getElementById('imageContainer');
  if (container) {
    container.style.transform = 'scale(' + _previewScale + ') rotate(' + _previewRotation + 'deg)';
    container.style.transformOrigin = 'top center';
    container.style.transition = 'transform 0.2s ease';
  }
}

// ล้าง iframe เมื่อปิด modal
$(document).on('hide.bs.modal', '#previewModal', function () {
  var iframeEl = document.getElementById('previewIframe');
  if (iframeEl) iframeEl.src = '';
  _previewScale = 1;
  _previewRotation = 0;
});
</script>
